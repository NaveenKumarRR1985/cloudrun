FROM python:3.12-slim-bullseye

# Bring the OneAgent zip at build time
ARG ZIP_FILE=payload.zip
RUN mkdir -p /image
COPY ${ZIP_FILE} /image/oneagent.zip

# config
ENV DT_STAGE=nonprod
ENV HEALTH_PORT=8082
ENV HEALTH_PATH=/healthz

# entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# health port (for humans/tools; Cloud Run doesn't require EXPOSE)
EXPOSE 8082

# need to write to /opt/dynatrace (shared tmpfs)
USER 0
ENTRYPOINT ["/entrypoint.sh"]
